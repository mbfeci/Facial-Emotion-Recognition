dataDir = fullfile('Data', 'data_all_noise');

data = imageDatastore(dataDir);

labelDir = fullfile(dataDir, 'label.txt');
fileID = fopen(labelDir,'r');
labels = fscanf(fileID, '%d');
fclose(fileID);
data.ReadFcn = @reader;

data.Labels = categorical(labels, [1 2 3 4 5], {'Angry' 'Happy' 'Sad' 'Suprised' 'Neutral'});

[trainImages, validationImages] = splitEachLabel(data, 0.8, 'randomized');

disp(['Training image set size is: ', num2str(length(trainImages.Files))]);
disp(['Validation image set size is: ', num2str(length(validationImages.Files))]);

netVGG = vgg16;
layersTransfer = netVGG.Layers(1:end-3);
layers = [layersTransfer
    fullyConnectedLayer(5, 'WeightLearnRateFactor', 10, 'BiasLearnRateFactor', 10)
    softmaxLayer
    classificationLayer];

miniBatchSize = 64;

options = trainingOptions('sgdm',...
    'MiniBatchSize',miniBatchSize,...
    'LearnRateSchedule','piecewise',...
    'LearnRateDropFactor',0.8,...
    'LearnRateDropPeriod',1,...
    'MaxEpochs',12,...
    'InitialLearnRate',1e-4,...
    'Plots','training-progress',...
    'ValidationData',validationImages,...
    'ValidationFrequency',118, ...
    'ValidationPatience', 2);

netVGG = trainNetwork(trainImages, layers, options);

function y = reader(img)
    y = imread(img);
    if size(y,3)==1
        y = cat(3,y,y,y);
    end
end

%{
Run 1:
    - Normal data
    - LR: 1e-4
    - LRDrop: 0.2
    - LRDropPeriod: 2 (Epochs)
    - Epoch: 8
    - LastLayerLRWeight: 8

Log 1:
Training image set size is: 690
Validation image set size is: 172
Training on single GPU.
Initializing image normalization.
|=======================================================================================================================|
|     Epoch    |   Iteration  | Time Elapsed |  Mini-batch  |  Validation  |  Mini-batch  |  Validation  | Base Learning|
|              |              |  (seconds)   |     Loss     |     Loss     |   Accuracy   |   Accuracy   |     Rate     |
|=======================================================================================================================|
|            1 |            1 |         1.31 |       1.6556 |       1.5292 |       25.00% |       32.56% |     1.00e-04 |
|            1 |           50 |        28.59 |       1.4182 |              |       37.50% |              |     1.00e-04 |
|            1 |           86 |        46.55 |       0.4779 |       0.7489 |       87.50% |       69.19% |     1.00e-04 |
|            2 |          100 |        56.66 |       1.3488 |              |       50.00% |              |     1.00e-04 |
|            2 |          150 |        81.42 |       0.8911 |              |       62.50% |              |     1.00e-04 |
|            2 |          172 |        92.05 |       0.3256 |       0.5886 |       87.50% |       77.33% |     1.00e-04 |
|            3 |          200 |       109.04 |       0.3383 |              |       75.00% |              |     2.00e-05 |
|            3 |          250 |       133.98 |       0.2334 |              |      100.00% |              |     2.00e-05 |
|            3 |          258 |       138.03 |       0.1364 |       0.5836 |      100.00% |       76.16% |     2.00e-05 |
|            4 |          300 |       161.93 |       0.5543 |              |       75.00% |              |     2.00e-05 |
|            4 |          344 |       183.92 |       0.2785 |       0.5554 |       87.50% |       77.33% |     2.00e-05 |
|            5 |          350 |       189.78 |       0.3991 |              |       87.50% |              |     4.00e-06 |
|            5 |          400 |       215.67 |       0.3120 |              |       87.50% |              |     4.00e-06 |
|            5 |          430 |       230.74 |       0.1517 |       0.4971 |       87.50% |       81.98% |     4.00e-06 |
|            6 |          450 |       243.83 |       0.3573 |              |       75.00% |              |     4.00e-06 |
|            6 |          500 |       269.13 |       0.0290 |              |      100.00% |              |     4.00e-06 |
|            6 |          516 |       277.17 |       0.1444 |       0.4947 |      100.00% |       81.98% |     4.00e-06 |
|            7 |          550 |       297.25 |       0.0631 |              |      100.00% |              |     8.00e-07 |
|            7 |          600 |       322.41 |       0.1386 |              |      100.00% |              |     8.00e-07 |
|            7 |          602 |       323.43 |       0.2253 |       0.4868 |      100.00% |       81.40% |     8.00e-07 |
|            8 |          650 |       350.67 |       0.1209 |              |      100.00% |              |     8.00e-07 |
|            8 |          688 |       369.88 |       0.1920 |       0.4784 |       87.50% |       81.40% |     8.00e-07 |
|=======================================================================================================================|

Run 2:
    - Data with noise
    - LR: 1e-4
    - LRDrop: 0.8
    - LRDropPeriod: 1 (Epochs)
    - Epoch: 12
    - LastLayerLRWeight: 10
Log 2:
Training image set size is: 7586
Validation image set size is: 1896
Training on single GPU.
Initializing image normalization.
|=======================================================================================================================|
|     Epoch    |   Iteration  | Time Elapsed |  Mini-batch  |  Validation  |  Mini-batch  |  Validation  | Base Learning|
|              |              |  (seconds)   |     Loss     |     Loss     |   Accuracy   |   Accuracy   |     Rate     |
|=======================================================================================================================|
|            1 |            1 |         5.21 |       2.2737 |       1.5209 |       23.44% |       39.29% |     1.00e-04 |
|            1 |           50 |       270.13 |       1.1740 |              |       65.63% |              |     1.00e-04 |
|            1 |          100 |       480.51 |       0.7727 |              |       71.88% |              |     1.00e-04 |
|            1 |          118 |       557.71 |       0.8254 |       0.6723 |       67.19% |       76.53% |     1.00e-04 |
|            2 |          150 |       747.40 |       0.5152 |              |       85.94% |              |     8.00e-05 |
|            2 |          200 |       959.49 |       0.6664 |              |       73.44% |              |     8.00e-05 |
|            2 |          236 |      1112.52 |       0.4700 |       0.4803 |       85.94% |       82.38% |     8.00e-05 |
|            3 |          250 |      1223.64 |       0.5767 |              |       81.25% |              |     6.40e-05 |
|            3 |          300 |      1433.08 |       0.2594 |              |       87.50% |              |     6.40e-05 |
|            3 |          350 |      1644.18 |       0.4816 |              |       81.25% |              |     6.40e-05 |
|            3 |          354 |      1661.00 |       0.3618 |       0.3430 |       84.38% |       87.61% |     6.40e-05 |
|            4 |          400 |      1906.43 |       0.2701 |              |       90.63% |              |     5.12e-05 |
|            4 |          450 |      2118.85 |       0.1789 |              |       95.31% |              |     5.12e-05 |
|            4 |          472 |      2211.74 |       0.1910 |       0.2796 |       92.19% |       89.72% |     5.12e-05 |
|            5 |          500 |      2379.58 |       0.2029 |              |       93.75% |              |     4.10e-05 |
|            5 |          550 |      2590.05 |       0.1493 |              |       93.75% |              |     4.10e-05 |
|            5 |          590 |      2760.56 |       0.1959 |       0.3059 |       93.75% |       88.92% |     4.10e-05 |
|            6 |          600 |      2854.14 |       0.2526 |              |       89.06% |              |     3.28e-05 |
|            6 |          650 |      3067.36 |       0.2460 |              |       90.63% |              |     3.28e-05 |
|            6 |          700 |      3277.05 |       0.1319 |              |       95.31% |              |     3.28e-05 |
|            6 |          708 |      3310.57 |       0.1287 |       0.2479 |       96.88% |       91.35% |     3.28e-05 |
|            7 |          750 |      3537.67 |       0.0649 |              |       98.44% |              |     2.62e-05 |
|            7 |          800 |      3747.46 |       0.1628 |              |       92.19% |              |     2.62e-05 |
|            7 |          826 |      3857.13 |       0.0804 |       0.1954 |       95.31% |       93.20% |     2.62e-05 |
|            8 |          850 |      4007.87 |       0.0782 |              |       98.44% |              |     2.10e-05 |
|            8 |          900 |      4215.33 |       0.1044 |              |       98.44% |              |     2.10e-05 |
|            8 |          944 |      4398.69 |       0.0677 |       0.1764 |      100.00% |       93.99% |     2.10e-05 |
|            9 |          950 |      4473.84 |       0.1451 |              |       95.31% |              |     1.68e-05 |
|            9 |         1000 |      4682.87 |       0.0671 |              |       98.44% |              |     1.68e-05 |
|            9 |         1050 |      4893.19 |       0.2089 |              |       92.19% |              |     1.68e-05 |
|            9 |         1062 |      4943.73 |       0.0912 |       0.1701 |       96.88% |       94.09% |     1.68e-05 |
|           10 |         1100 |      5154.24 |       0.0744 |              |       98.44% |              |     1.34e-05 |
|           10 |         1150 |      5364.29 |       0.0981 |              |       96.88% |              |     1.34e-05 |
|           10 |         1180 |      5489.70 |       0.0874 |       0.1516 |       96.88% |       94.94% |     1.34e-05 |
|           11 |         1200 |      5624.19 |       0.0545 |              |       98.44% |              |     1.07e-05 |
|           11 |         1250 |      5833.66 |       0.1329 |              |       92.19% |              |     1.07e-05 |
|           11 |         1298 |      6035.91 |       0.0592 |       0.1546 |       96.88% |       94.73% |     1.07e-05 |
|           12 |         1300 |      6096.91 |       0.1033 |              |       96.88% |              |     8.59e-06 |
|           12 |         1350 |      6304.57 |       0.0554 |              |       98.44% |              |     8.59e-06 |
|           12 |         1400 |      6514.95 |       0.0759 |              |       98.44% |              |     8.59e-06 |
|           12 |         1416 |      6582.00 |       0.0399 |       0.1470 |      100.00% |       95.09% |     8.59e-06 |
|=======================================================================================================================|
%}